#!/usr/bin/env python3.6
import sys
import tarfile
import hashlib
import os

os.chdir(os.path.expanduser('~/'))

with open('.backup/index') as f:
    index_raw = [x.strip().split('\t') for x in f]
    index = {path: {'blake2b': blake2b, 'tar': tar} for path, tar, blake2b, _size in index_raw}

changes = {}
state = {}

def copyfileobj(src, dst, length=None, exception=OSError, bufsize=None):
    bufsize = 16 * 1024
    state['size'] = length
    blake2b = state['blake2b']
    if length == 0:
        return
    assert length
    blocks, remainder = divmod(length, bufsize)
    for b in range(blocks):
        buf = src.read(bufsize)
        if len(buf) < bufsize:
            raise exception("unexpected end of data")
        blake2b.update(buf)
        dst.write(buf)
    if remainder != 0:
        buf = src.read(remainder)
        if len(buf) < remainder:
            raise exception("unexpected end of data")
        blake2b.update(buf)
        dst.write(buf)
tarfile.copyfileobj = copyfileobj

with tarfile.open(fileobj=sys.stdout.buffer, mode='w|') as tar:
    for path in sys.stdin:
        path = path.strip()
        state['blake2b'] = hashlib.blake2b()
        tar.add(path)
        blake2b = state['blake2b'].hexdigest()
        if index[path]['blake2b'] != blake2b:
            changes[path] = blake2b, state['size']

with open('.backup/index', 'w') as f:
    for path, tar, blake2b, size in index_raw:
        if path in changes:
            blake2b, size = changes[path]
            print('changed:', path, blake2b, size, file=sys.stderr)
        f.write('\t'.join([path, tar, blake2b, str(size)]) + '\n')
