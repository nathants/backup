#!/bin/bash
set -euo pipefail

cd $BACKUP_ROOT/.backup

git status --porcelain | awk '{print $2}' | while read name; do
    if [ "$name" != index ] && ! echo "$name" | grep -P '\.tar\.lz4\.gpg\.'; then
        echo fatal: aborting backup-commit, $BACKUP_ROOT/.backup working directory in unknown state. start over with backup-reset
        git status --porcelain
        exit 1
    fi
done

if tarballs=$(ls *.tar.lz4.gpg.* 2>/dev/null); then
    for name in $tarballs; do
        -backup-put $name
    done
    git commit -m "$(for name in $tarballs; do echo $name $(cat $name.blake2b); done)"
    rm *.tar.lz4.gpg.*
else
    git commit -m "index-only-update"
fi

git push
