#!/bin/bash
set -euo pipefail

export LC_ALL=C
cd ~/.backup

status() { git status -s | sed -r 's/ +/ /g'; }
if ! ([ -z "$(status)" ] || [ 'M index' = "$(status)" ]); then
    echo error: ~/.backup working directory not clean
    status
    exit 1
fi

backup-diff | backup-partition | while read path; do
    echo process chunk: $path >&2
    cat $path \
        | backup-tar  \
        | lz4 \
        | gpg -esv --no-armor \
        | tee >(backup-blake2b > $path.blake2b) \
        | pv -r \
        | backup-put $path > put
    rm $path
done

dest=$(cat put | sed -r 's/\.[0-9]+$//')
rm put
git add index
git commit -m "
backup-commit
$dest
$(for path in *.blake2b; do
    echo $(echo $path | sed s/\.blake2b//) $(cat $path)
    rm $path
done)
"

git push
