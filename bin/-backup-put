#!/bin/bash
set -euo pipefail

name=$1

remote=$BACKUP_RCLONE_REMOTE:$BACKUP_DESTINATION/tar/$name

tempfile=$(mktemp -p $BACKUP_ROOT/.backup)

echo start backup-put: $remote 1>&2

cat $name \
    | lz4 \
    | gpg \
          -esv \
          --no-armor \
          --cipher-algo aes256 \
          --digest-algo sha512 \
          --force-mdc \
              > $tempfile

cat $tempfile | -backup-blake2b > $name.blake2b

ls -l $tempfile | awk '{print $5}' > $name.size

rclone copyto --progress --error-on-no-transfer $tempfile $remote 1>&2

rm $tempfile

echo finished backup-put: $remote 1>&2
