#!/bin/bash
set -euo pipefail

export LC_ALL=C
cd ~/.backup

status() { git status -s | sed -r 's/ +/ /g'; }
if ! ([ -z "$(status)" ] || [ 'M index' = "$(status)" ]); then
    echo error: ~/.backup working directory not clean
    status
    exit 1
fi

touch index
cat index | backup-index | sort > index.new
mv -f index.new index
git add index
backup-diff | backup-dedupe > index.dupes
sort -m index index.dupes | backup-keeplast > index.new
mv -f index.new index
git add index
rm index.*
echo novel data to commit: $(backup-size)
