#!/bin/bash
set -euo pipefail

if [ ! -d $BACKUP_ROOT/.backup ]; then
    mkdir -p $BACKUP_ROOT/.backup
    (
        cd $BACKUP_ROOT/.backup
        git init
    )
fi

cd $BACKUP_ROOT/.backup

status() { git status -s | sed -r 's/ +/ /g'; }
if ! [ -z "$(status)" ]; then
    echo error: $BACKUP_ROOT/.backup working directory not clean
    status
    exit 1
fi

if [ ! -f ignore ]; then
    echo '^\./\.backup/' > ignore
fi

if [ ! -f index ]; then
    touch index
    git add index
    git commit -m 'init index'
fi
cat index | -backup-index | LC_ALL=C sort > index.new
mv -f index.new index
git add index
backup-diff | -backup-dedupe > index.dupes
LC_ALL=C sort -m index index.dupes | -backup-keeplast > index.new
mv -f index.new index
git add index
rm index.*
echo novel data to commit: $(-backup-size)
